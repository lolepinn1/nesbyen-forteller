<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <title>Historien om Nesbyens næringsliv (GeoJSON-loader)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  <style>
    html, body { height: 100%; margin: 0; }
    #map { position: absolute; inset: 0; }
    .panel {
      position: absolute; z-index: 2; left: 16px; top: 16px;
      background: #fff; border-radius: 14px; padding: 14px 14px 10px;
      box-shadow: 0 10px 25px rgba(0,0,0,.15); font-family: system-ui, sans-serif; max-width: 460px; width: 460px;
    }
    .row { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
    .muted { color: #666; font-size: 12px; }
    .year { font-weight: 700; font-variant-numeric: tabular-nums; }
    .controls { display: flex; gap: 8px; margin-top: 8px; flex-wrap: wrap; }
    .btn { border: 1px solid #e5e5e5; background: #f7f7f7; padding: 6px 10px; border-radius: 8px; cursor: pointer; }
    .btn:active { transform: translateY(1px); }
    input[type="range"] { width: 100%; }
    .legend { display: grid; grid-template-columns: auto 1fr; gap: 6px 10px; margin-top: 10px; }
    .dot { width: 12px; height: 12px; border-radius: 50%; margin-top: 2px; }
    .dot.industry { background:#000000; }
    .dot.grocery { background:#1f78b4; }
    .dot.sport { background:#33a02c; }
    .dot.building { background:#6a3d9a; }
    .dot.interiors { background:#e31a1c; }
    .dot.architecture { background:#a52a2a; }
    .filters { display: grid; grid-template-columns: 1fr 1fr; gap: 6px 10px; margin-top: 8px; }
    .filters label { font-size: 13px; color: #333; }
    .footer { margin-top: 8px; }
    .footer a { color: #0a64ff; text-decoration: none; }
    .badge { display:inline-block; padding:2px 6px; border-radius:6px; background:#eef2ff; color:#2b3a67; font-size:11px; }
    .alert { background:#fff7e6; border:1px solid #ffd591; color:#8b4513; padding:8px 10px; border-radius:8px; margin-top:8px; font-size:13px; }
    .hidden { display:none; }
    .ok { background:#eefcf1; border:1px solid #b7e2c1; color:#165c2b; padding:8px 10px; border-radius:8px; margin-top:8px; font-size:13px; }
    code { background:#f6f6f6; padding:0 4px; border-radius:4px; }
  

/* === MOBILVENNLIG LAYOUT (RESPONSIV) v2 === */
@media (max-width: 640px) {
  .panel {
    position: fixed;
    left: 4%;
    right: 4%;
    bottom: 12px;
    top: auto;
    width: auto;
    max-width: 420px;
    max-height: 55vh;
    padding: 10px 14px;
    overflow-y: auto;
    background: rgba(255,255,255,0.95);
    backdrop-filter: blur(8px);
    border-radius: 14px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.25);
  }

  .row, .controls, .filters {
    flex-direction: column;
    align-items: flex-start;
    gap: 8px;
  }

  .btn, select, input[type="range"] {
    width: 100%;
    font-size: 15px;
  }

  input[type="range"] {
    height: 24px;
  }

  .legend {
    grid-template-columns: auto 1fr;
  }

  .footer {
    text-align: center;
  }

  #map { height: 100vh; }

  .alert, .ok {
    font-size: 15px;
    padding: 10px 14px;
  }
}

</style>
</head>
<body>
  <div id="map"></div>

  <div class="panel">
    <div class="row" style="justify-content: space-between; margin-bottom:6px;">
      <div>
        <div style="font-weight:700;">Historien om Nesbyens næringsliv</div>
        <div class="muted">Dra i tidslinjen for å se hvilke virksomheter som er aktive et gitt år.</div>
      </div>
      <span class="badge">GeoJSON</span>
    </div>

    <div class="row">
      <label for="year">År:</label>
      <div class="year" id="year-value">2020</div>
    </div>
    <input id="year" type="range" min="1900" max="2025" value="2020" step="1" />
    <div class="controls">
      <button id="play" class="btn" title="Spill av">▶ Spill av</button>
      <button id="pause" class="btn" title="Pause">⏸ Pause</button>
      <button id="reset" class="btn" title="Til start">↺ Reset</button>
    </div>

    <div class="row" style="margin-top:8px; gap:10px; align-items: center;">
      <label class="muted">Kartstil:</label>
      <select id="basemap" class="btn" style="padding:6px 10px;">
        <option value="mapbox://styles/mapbox/light-v11" selected>Light</option>
        <option value="mapbox://styles/mapbox/streets-v12">Streets</option>
        <option value="mapbox://styles/mapbox/outdoors-v12">Outdoors</option>
        <option value="mapbox://styles/mapbox/satellite-streets-v12">Satellite + Streets</option>
      </select>
      <label class="muted" style="margin-left:8px;">Visning:</label>
      <select id="viewmode" class="btn" style="padding:6px 10px;">
        <option value="points" selected>Punkt</option>
        <option value="cluster">Klynge</option>
        <option value="heatmap">Heatmap</option>
      </select>
    </div>

    <div class="filters">
      <label><input type="checkbox" class="cat" value="Industri" checked> Industri</label>
      <label><input type="checkbox" class="cat" value="Dagligvare" checked> Dagligvare</label>
      <label><input type="checkbox" class="cat" value="Sport" checked> Sport</label>
      <label><input type="checkbox" class="cat" value="Byggevarer" checked> Byggevarer</label>
      <label><input type="checkbox" class="cat" value="Interiør" checked> Interiør</label>
      <label><input type="checkbox" class="cat" value="Arkitektur" checked> Arkitektur</label>
    </div>

    <div id="empty-state" class="alert hidden">Ingen steder for <strong><span id="empty-year">2020</span></strong> med gjeldende filtre.</div>
    <div id="diag" class="ok hidden"></div>

    <div class="legend">
      <div class="dot industry"></div><div>Industri</div>
      <div class="dot grocery"></div><div>Dagligvare</div>
      <div class="dot sport"></div><div>Sport</div>
      <div class="dot building"></div><div>Byggevarer</div>
      <div class="dot interiors"></div><div>Interiør</div>
      <div class="dot architecture"></div><div>Arkitektur</div>
    </div>

    <div class="footer muted">Kilde: ekstern <code>nesbyen_poi.geojson</code> i samme mappe. </div>
  </div>

  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <script>
  (function(){
    mapboxgl.accessToken = 'pk.eyJ1IjoibG9sZXBpbm5lbiIsImEiOiJjajAycW50bnUwMDloMnFwMGdyeWk3ZHNnIn0.dq4CH2uwUPRGNXkdt7EZtA';
    const toNum = (v, d) => Number.isFinite(+v) ? +v : d;

    // State
    let storeData = { type:'FeatureCollection', features: [] };
    let currentStyle = 'mapbox://styles/mapbox/light-v11';
    const map = new mapboxgl.Map({ container:'map', style: currentStyle, center:[9.1,60.572], zoom:13.8 });
    map.addControl(new mapboxgl.NavigationControl(), 'top-right');

    let currentYear = 2020;
    let activeCategories = new Set(['Industri','Dagligvare','Sport','Byggevarer','Interiør','Arkitektur']);
    let viewMode = 'points';

    function colorByCategory(){
      return ['match',['get','category'],
        'Industri','#000000',
        'Dagligvare','#1f78b4',
        'Sport','#33a02c',
        'Byggevarer','#6a3d9a',
        'Interiør','#e31a1c',
        'Arkitektur','#a52a2a',
        '#444'
      ];
    }

    function filteredFeatures(){
      return (storeData.features || []).filter(f => {
        const p = f.properties || {};
        const open = toNum(p.year_open, -9999);
        const close = (p.year_close == null) ? 9999 : toNum(p.year_close, 9999);
        const catOk = activeCategories.has(String(p.category));
        return open <= currentYear && close >= currentYear && catOk;
      });
    }

    function ensureSources(){
      if (!map.getSource('stores')) map.addSource('stores', { type:'geojson', data: storeData });
      if (!map.getSource('stores_filtered')) map.addSource('stores_filtered', { type:'geojson', data: { type:'FeatureCollection', features: [] } });
      if (!map.getSource('stores_filtered_cluster')) map.addSource('stores_filtered_cluster', { type:'geojson', data: { type:'FeatureCollection', features: [] }, cluster:true, clusterMaxZoom:14, clusterRadius:40 });
    }

    function addPointLayers(){
      if (!map.getLayer('stores-circles')){
        map.addLayer({ id:'stores-circles', type:'circle', source:'stores_filtered', paint:{
          'circle-radius': ['interpolate',['linear'],['zoom'], 10,5, 14,8, 16,12],
          'circle-color': colorByCategory(),
          'circle-opacity': 0.9,
          'circle-stroke-color':'#000','circle-stroke-opacity':0.15,'circle-stroke-width':1
        }});
      }
      if (!map.getLayer('stores-labels')){
        map.addLayer({ id:'stores-labels', type:'symbol', source:'stores_filtered', layout:{ 'text-field':['get','name'], 'text-size':12, 'text-offset':[0,1.2], 'text-allow-overlap':false }, paint:{ 'text-color':'#1b1b1b','text-halo-color':'#fff','text-halo-width':0.8 } });
      }
    }

    function addClusterLayers(){
      if (!map.getLayer('clusters')){
        map.addLayer({ id:'clusters', type:'circle', source:'stores_filtered_cluster', filter:['has','point_count'], paint:{
          'circle-color': ['step',['get','point_count'], '#8ecae6', 5, '#219ebc', 15, '#023047'],
          'circle-radius': ['step',['get','point_count'], 12, 5, 18, 15, 24]
        }});
      }
      if (!map.getLayer('cluster-count')){
        map.addLayer({ id:'cluster-count', type:'symbol', source:'stores_filtered_cluster', filter:['has','point_count'], layout:{ 'text-field':['get','point_count_abbreviated'], 'text-size':12 } });
      }
      if (!map.getLayer('unclustered-point')){
        map.addLayer({ id:'unclustered-point', type:'circle', source:'stores_filtered_cluster', filter:['!',['has','point_count']], paint:{ 'circle-radius':8, 'circle-color':'#fb8500', 'circle-stroke-color':'#000', 'circle-stroke-width':1, 'circle-stroke-opacity':0.2 } });
      }
    }

    function addHeatmapLayer(){
      if (!map.getLayer('stores-heatmap')){
        map.addLayer({ id:'stores-heatmap', type:'heatmap', source:'stores_filtered', maxzoom:15, paint:{
          'heatmap-weight': 1,
          'heatmap-intensity': ['interpolate',['linear'],['zoom'], 10,0.5, 15,1.2],
          'heatmap-radius': ['interpolate',['linear'],['zoom'], 10,18, 15,28],
          'heatmap-opacity': ['interpolate',['linear'],['zoom'], 10,0.9, 15,0.6]
        }});
      }
    }

    function showMode(mode){
      const show = (id, vis) => { if(map.getLayer(id)) map.setLayoutProperty(id, 'visibility', vis ? 'visible':'none'); };
      ['stores-circles','stores-labels','clusters','cluster-count','unclustered-point','stores-heatmap'].forEach(id => show(id, false));
      if (mode === 'points'){ show('stores-circles', true); show('stores-labels', true); }
      if (mode === 'cluster'){ show('clusters', true); show('cluster-count', true); show('unclustered-point', true); }
      if (mode === 'heatmap'){ show('stores-heatmap', true); }
    }

    function rebuildLayers(){
      ensureSources();
      addPointLayers();
      addClusterLayers();
      addHeatmapLayer();
      showMode(viewMode);
    }

    function applyFilter(){
      const feats = filteredFeatures();
      const fc = { type:'FeatureCollection', features: feats };
      if (map.getSource('stores_filtered')) map.getSource('stores_filtered').setData(fc);
      if (map.getSource('stores_filtered_cluster')) map.getSource('stores_filtered_cluster').setData(fc);

      const count = feats.length;
      const emptyEl = document.getElementById('empty-state');
      const emptyYearEl = document.getElementById('empty-year');
      if (emptyEl && emptyYearEl){
        if (count === 0){ emptyYearEl.textContent = String(currentYear); emptyEl.classList.remove('hidden'); }
        else { emptyEl.classList.add('hidden'); }
      }
      const diag = document.getElementById('diag');
      if (diag){ diag.innerHTML = `Synlige steder for <code>${currentYear}</code>: <strong>${count}</strong>`; diag.classList.remove('hidden'); }
    }

    function initAll(){
      rebuildLayers();
      applyFilter();

      function popupHandler(e){
        try {
          const f = e.features && e.features[0];
          const p = f ? f.properties : {};
          const name = String(p.name || 'Ukjent');
          const cat = String(p.category || '');
          const addr = String(p.address || '');
          const open = (p.year_open != null) ? String(p.year_open) : 'ukjent';
          const close = (p.year_close == null) ? 'I drift' : String(p.year_close);
          const link = p.url ? `<br/><a href="${String(p.url)}" target="_blank" rel="noopener">Nettside</a>` : '';
          new mapboxgl.Popup().setLngLat(e.lngLat).setHTML(`<strong>${name}</strong><br/>${cat}<br/>${addr}<br/><small>Åpnet: ${open} – ${close}</small>${link}`).addTo(map);
        } catch(err) { console.error('Popup error', err); }
      }
      if (!map.__popupsBound){
        map.on('click','stores-circles', popupHandler);
        map.on('click','unclustered-point', popupHandler);
        map.on('mouseenter','stores-circles', () => map.getCanvas().style.cursor='pointer');
        map.on('mouseleave','stores-circles', () => map.getCanvas().style.cursor='');
        map.on('mouseenter','unclustered-point', () => map.getCanvas().style.cursor='pointer');
        map.on('mouseleave','unclustered-point', () => map.getCanvas().style.cursor='');
        map.__popupsBound = true;
      }
    }

    // UI wiring
    const yearEl = document.getElementById('year');
    const yearVal = document.getElementById('year-value');
    const playBtn = document.getElementById('play');
    const pauseBtn = document.getElementById('pause');
    const resetBtn = document.getElementById('reset');
    const basemapEl = document.getElementById('basemap');
    const viewmodeEl = document.getElementById('viewmode');

    function setYear(y){ currentYear = toNum(y, currentYear); yearVal.textContent = String(currentYear); applyFilter(); }
    setYear(yearEl.value);

    yearEl.addEventListener('input', (e) => setYear(e.target.value));

    let timer = null;
    playBtn.addEventListener('click', () => {
      if (timer) return;
      timer = setInterval(() => {
        let v = toNum(yearEl.value, currentYear);
        v = (v >= toNum(yearEl.max, 2025)) ? toNum(yearEl.min, 1900) : v + 1;
        yearEl.value = String(v);
        setYear(v);
      }, 600);
    });
    pauseBtn.addEventListener('click', () => { if (timer) { clearInterval(timer); timer = null; } });
    resetBtn.addEventListener('click', () => { yearEl.value = '2020'; setYear(2020); });

    document.querySelectorAll('.cat').forEach((cb) => {
      cb.addEventListener('change', () => {
        if (cb.checked) activeCategories.add(cb.value); else activeCategories.delete(cb.value);
        applyFilter();
      });
    });

    basemapEl.addEventListener('change', () => {
      const next = basemapEl.value;
      if (next === currentStyle) return;
      currentStyle = next;
      map.setStyle(currentStyle);
      map.once('styledata', () => {
        rebuildLayers();
        applyFilter();
      });
    });

    viewmodeEl.addEventListener('change', () => {
      const mode = viewmodeEl.value;
      if (mode !== 'points' && mode !== 'cluster' && mode !== 'heatmap') return;
      viewMode = mode;
      showMode(viewMode);
    });

    // Load external GeoJSON in same folder
    const statusEl = document.getElementById('diag');
    fetch('nesbyen_poi.geojson', {cache:'no-store'})
      .then(r => { if(!r.ok) throw new Error('HTTP ' + r.status); return r.json(); })
      .then(geo => {
        storeData = geo;
        if (statusEl) {
          statusEl.classList.remove('hidden');
          statusEl.textContent = `GeoJSON lastet: ${storeData.features?.length || 0} steder.`;
        }
        initAll();
      })
      .catch(err => {
        console.error('Kunne ikke laste GeoJSON:', err);
        if (statusEl) {
          statusEl.classList.remove('hidden');
          statusEl.textContent = 'Feil: Kunne ikke laste GeoJSON (sjekk filnavn og plassering).';
        }
      });
  })();
  </script>
</body>
</html>
